# docker-compose.yml
version: '3.8'

services:
  # --- Servicio de Autenticación ---
  ms-auth:
    build: ./ms-auth
    ports:
      - "4000:4000" # Mapea el puerto 4000 de tu máquina al 4000 del contenedor
    environment:
      - PORT=4000
      - JWT_SECRET=ESTE_ES_UN_SECRETO_PARA_DESARROLLO_NO_USAR_EN_PROD
      - JWT_EXPIRES_IN=1h

  # --- Servicio de Usuarios ---
  ms-usuarios:
    build: ./ms-usuarios
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
    # --- NUEVAS VARIABLES PARA LA BD ---
      - DB_HOST=db-usuarios # El nombre del servicio de la BD en Docker Compose
      - DB_PORT=5432
      - DB_USER=user_usuarios
      - DB_PASSWORD=password_usuarios
      - DB_NAME=db_usuarios
    depends_on: # Asegura que la BD inicie antes que el servicio
      - db-usuarios

  # --- Servicio de Agenda ---
  ms-agenda:
    build: ./ms-agenda
    ports:
      - "3002:3002"
    environment:
      - PORT=3002

  # --- Servicio de Notificaciones ---
  ms-notificaciones:
    build: ./ms-notificaciones
    ports:
      - "3003:3003"
    environment:
      - PORT=3003
  
  # --- Servicio de Tutorías (El Orquestador) ---
  ms-tutorias:
    build: ./ms-tutorias
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      # --- CAMBIO CRÍTICO DE NETWORKING ---
      # Dentro de la red de Docker, los servicios se comunican usando su nombre de servicio,
      # no 'localhost'. Docker Compose se encarga de resolver estos nombres.
      - MS_USUARIOS_URL=http://ms-usuarios:3001/usuarios
      - MS_AGENDA_URL=http://ms-agenda:3002/agenda
      - MS_NOTIFICACIONES_URL=http://ms-notificaciones:3003/notificaciones
      - JWT_SECRET=ESTE_ES_UN_SECRETO_PARA_DESARROLLO_NO_USAR_EN_PROD
    depends_on:
      - ms-auth
      - ms-usuarios
      - ms-agenda
      - ms-notificaciones

  # --- NUEVO: Servicio de Base de Datos PostgreSQL ---
  db-usuarios:
    image: postgres:14-alpine # Usamos una imagen oficial de PostgreSQL
    container_name: db_usuarios_postgres
    environment:
      POSTGRES_USER: user_usuarios # Define el usuario de la BD
      POSTGRES_PASSWORD: password_usuarios # Define la contraseña
      POSTGRES_DB: db_usuarios   # Define el nombre de la base de datos
    ports:
      - "5432:5432" # Expone el puerto de Postgres (opcional, para conectar desde tu máquina si necesitas)
    volumes:
      - postgres_data_usuarios:/var/lib/postgresql/data # Persiste los datos fuera del contenedor

# --- NUEVO: Definición de Volúmenes ---
volumes:
  postgres_data_usuarios: